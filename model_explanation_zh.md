# 美食大战老鼠卡片强化模型详细解释

## 模型概述

本模型旨在为"美食大战老鼠"游戏中的卡片强化系统提供最优决策策略，特别考虑了四叶草加成和失败降级惩罚的情况。当主卡大于6星时，使用蒙特卡洛模拟来确定惩罚值，从而更准确地计算卡片的真实价值和最优强化路径。

## 基本假设

1. 卡片强化成功率取决于主卡和副卡的星级差异
2. 使用多张副卡可以提高成功率
3. 四叶草、VIP等级和公会等级可以提供成功率加成
4. 6星及以上卡片强化失败会导致降级
5. 卡片价值是累积的，包括基础价值和所有强化成本

## 模型组成部分

### 1. 基础成功率表

模型使用预定义的成功率表，根据主卡和副卡的星级差异确定基础成功率：

```
p_list = [
    ["主卡星级→目标星级", "0→1", "1→2", "2→3", "3→4", "4→5", "5→6", "6→7", "7→8", "8→9", "9→10", "10→11", "11→12", "12→13", "13→14", "14→15", "15→16"],
    ["副卡低2星，好卡", -1, -1, 0.608, 0.429, 0.242, 0.201, 0.132, 0.106, 0.06, 0.022, 0.018, 0.017, 0.016, 0.014, 0.013, 0.01],
    ["副卡低1星，好卡", -1, 0.88, 0.792, 0.55, 0.403, 0.33, 0.264, 0.212, 0.132, 0.045, 0.046, 0.043, 0.04, 0.04, 0.034, 0.03],
    ["副卡同星，好卡", 1, 1, 0.968, 0.686, 0.495, 0.396, 0.319, 0.264, 0.22, 0.135, 0.125, 0.116, 0.107, 0.101, 0.095, 0.088]
]
```

### 2. 加成系统

模型考虑了三种加成：

1. **四叶草加成**：不同等级的四叶草提供不同的成功率倍数
   ```
   clover_levels = ['', '1', '2', '3', '4', '5', '6', 'S', 'SS', 'SSS', 'SSR']
   clover_additions = [1, 1.2, 1.4, 1.7, 2, 2.4, 2.7, 3, 3.2, 3.6, 4]
   ```

2. **VIP加成**：VIP等级提供额外的成功率百分比
   ```
   VIP_additions = [0]*4 + [0.04, 0.05, 0.07, 0.08, 0.09, 0.11, 0.13, 0.15, 0.17, 0.19]
   ```

3. **公会加成**：公会等级提供额外的成功率百分比
   ```
   guild_additions = [0, 0.01, 0.03, 0.05, 0.08, 0.12, 0.16]
   ```

### 3. 失败降级系统

当主卡星级≥6时，强化失败会导致卡片降级：

```
downgrade_levels = {
    6: 1,   # 6→7星失败降到5星
    7: 1,   # 7→8星失败降到6星
    8: 1,   # 8→9星失败降到7星
    9: 1,   # 9→10星失败降到8星
    10: 1,  # 10→11星失败降到9星
    11: 1,  # 11→12星失败降到10星
    12: 1,  # 12→13星失败降到11星
    13: 1,  # 13→14星失败降到12星
    14: 1,  # 14→15星失败降到13星
    15: 1   # 15→16星失败降到14星
}
```

## 算法流程

### 1. 初始化

- 加载预先计算的惩罚因子
- 初始化数据结构，包括卡片价值数组、成本数组和最佳策略数组

### 2. 对每个VIP和公会等级组合

对于每个VIP等级和公会等级组合，执行以下步骤：

### 3. 从低星级到高星级计算最优策略

对于每个星级$i$（从1到16）：

#### 对于1星卡片
- 直接使用同星副卡（0星）的成功率计算期望成本

#### 对于2星卡片
- 考虑同星（1星）和低1星（0星）副卡的组合
- 对每种组合计算基础成功率和材料成本
- 对每种四叶草等级计算加成后的成功率和总成本
- 计算期望成本和性价比
- 选择性价比最高的策略

#### 对于3星及以上卡片
- 考虑同星、低1星和低2星副卡的组合
- 对每种组合计算基础成功率和材料成本
- 对每种四叶草等级计算加成后的成功率和总成本
- 计算期望成本（考虑惩罚因子）和性价比
- 选择性价比最高的策略

### 4. 保存结果

将计算结果保存为JSON文件，包括：
- 最佳强化策略
- 各星级卡片的价值
- 各星级卡片的强化成本
- 各星级卡片的性价比

## 蒙特卡洛模拟详解

### 为什么需要蒙特卡洛模拟

在传统的期望成本计算中，我们假设每次强化尝试是独立的，且失败不会影响后续尝试。然而，在游戏中，当主卡星级≥6时，失败会导致卡片降级，这使得传统的期望成本计算方法不再准确。

蒙特卡洛模拟通过大量随机实验来近似计算实际期望成本，考虑了失败降级的影响。

### 模拟过程

1. 对于每个星级$i$（从6星开始）：
   a. 模拟大量（如10,000次）强化尝试
   b. 对于每次模拟：
      - 从初始星级开始
      - 重复尝试强化，直到成功达到目标星级
      - 记录所需的尝试次数和材料成本
   c. 计算平均尝试次数和平均材料成本
   d. 计算惩罚因子：$PF(S_i) = \frac{C_{simulated}(S_{i-1} \rightarrow S_i)}{C_{traditional}(S_{i-1} \rightarrow S_i)}$

### 惩罚因子的意义

惩罚因子$PF(S_i)$表示实际期望成本与理论期望成本的比值。通常$PF(S_i) < 1$，这是因为：

1. 失败降级后，我们需要从较低星级重新开始强化
2. 较低星级的强化成本通常低于当前星级
3. 较低星级的成功率通常高于当前星级

这种"降级后重新强化"的机制实际上降低了总体期望成本，因此惩罚因子通常小于1。

## 模型应用

通过引入惩罚因子，我们的模型能够更准确地反映游戏中卡片强化的实际成本，特别是考虑到失败降级的影响。这种方法结合了理论计算和蒙特卡洛模拟，为玩家提供了更优的强化策略决策。

模型的主要应用包括：

1. 为不同VIP等级和公会等级的玩家提供最优强化策略
2. 计算各星级卡片的实际价值和强化成本
3. 评估不同强化方案的性价比
4. 帮助玩家在资源有限的情况下做出最优决策

通过这种数学模型，玩家可以最大化资源利用效率，减少强化过程中的浪费，更快地提升卡片星级。